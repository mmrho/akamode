<?php
/**
 * Template Part: Address List & Form
 * Features: 
 * - Lists user addresses
 * - Add/Edit/Delete functionality
 * - Dynamic Iran Province & City dropdowns
 */

$api = get_query_var('api_client');
$addresses = $api->get_addresses();
if(is_wp_error($addresses)) $addresses = [];
?>

<div class="address-content">
    
    <div class="address-list" style="width: 100%; display:flex; flex-direction:column; gap:20px;">
        <p class="title">آدرس های ثبت شده</p>
        
        <?php if(empty($addresses)): ?>
            <p class="text">آدرسی وجود ندارد. لطفا یک آدرس جدید ایجاد کنید.</p>
        <?php else: ?>
            <?php foreach($addresses as $addr): 
                // داده‌ها را برای استفاده در جاوااسکریپت آماده می‌کنیم
                $json_addr = json_encode($addr);
            ?>
            <div class="address-item" style="border:1px solid #eee; padding:15px; border-radius:8px; position:relative;">
                <div class="row">
                    <strong>گیرنده:</strong> <?php echo esc_html($addr['full_name']); ?> 
                    | <strong>تلفن:</strong> <?php echo esc_html($addr['phone']); ?>
                </div>
                <div class="row">
                    <strong>استان/شهر:</strong> <?php echo esc_html($addr['state'] . ' - ' . $addr['city']); ?>
                </div>
                <div class="row">
                    <strong>آدرس:</strong> <?php echo esc_html($addr['address']); ?>
                </div>
                <div class="row">
                    <strong>کدپستی:</strong> <?php echo esc_html($addr['zip_code']); ?>
                </div>
                
                <div style="margin-top:10px; display:flex; gap:15px;">
                    <form method="post" onsubmit="return confirm('آیا از حذف این آدرس اطمینان دارید؟');">
                        <?php wp_nonce_field('wbs_delete_address'); ?>
                        <input type="hidden" name="wbs_action" value="delete_address">
                        <input type="hidden" name="address_id" value="<?php echo $addr['id']; ?>">
                        <button type="submit" style="background:none; border:none; color:red; cursor:pointer; font-size:12px;">حذف</button>
                    </form>

                    <button type="button" 
                            class="edit-address-btn" 
                            data-address='<?php echo esc_attr($json_addr); ?>'
                            style="background:none; border:none; color:blue; cursor:pointer; font-size:12px;">
                        ویرایش
                    </button>
                </div>
            </div>
            <?php endforeach; ?>
        <?php endif; ?>
    </div>

    <hr style="width:100%; border-top:1px dashed #ccc; margin:30px 0;">

    <div class="address" id="address-form-container">
        <p class="title" id="form-title">افزودن آدرس جدید</p>
        
        <form method="post" class="address-form" id="main-address-form">
            <?php wp_nonce_field('wbs_address_action'); ?>
            
            <input type="hidden" name="wbs_action" id="form-action" value="add_address">
            <input type="hidden" name="address_id" id="form-address-id" value="">

            <div class="select input">
                <input type="text" name="full_name" id="inp-fullname" placeholder="نام و نام خانوادگی تحویل گیرنده *" required>
            </div>

            <div class="select input">
                <input type="text" name="phone" id="inp-phone" placeholder="شماره تماس *" required>
            </div>

            <div class="select">
                <select name="state" id="inp-state" required>
                    <option value="">انتخاب استان *</option>
                </select>
            </div>
            
            <div class="select">
                <select name="city" id="inp-city" required>
                    <option value="">ابتدا استان را انتخاب کنید *</option>
                </select>
            </div>

            <div class="select input">
                <input type="text" name="address" id="inp-address" placeholder="آدرس دقیق پستی *" required>
            </div>
            
            <div class="select input">
                <input type="text" name="zip_code" id="inp-zip" placeholder="کد پستی *" required>
            </div>

            <div class="buttons">
                <button type="button" class="close" id="btn-cancel-edit">انصراف</button>
                <button type="submit" class="logout" id="btn-submit">ثبت آدرس</button>
            </div>
        </form>
    </div>
</div>

<script>
    // دیتابیس شهرهای ایران
    const iranCities = {
        "آذربایجان شرقی": ["تبریز", "مراغه", "مرند", "میانه", "اهر", "بناب", "سراب", "آذرشهر", "هادیشهر", "عجب‌شیر", "سردرود", "ملکان", "شبستر", "خسروشاه", "بستان‌آباد", "هشترود", "اسکو", "ایلخچی", "باسمنج", "ممقان", "گوگان", "هریس", "یامچی", "صوفیان", "کلیبر", "جلفا", "شندآباد", "کشکسرای", "تسوج", "کلوانق", "ترکمانچای", "لیلان", "سیس", "بخشایش", "قره‌آغاج", "مهربان", "تیمورلو", "ورزقان", "زرنق", "شربیان", "کوزه کنان", "وایقان", "هوراند", "مبارک شهر", "خامنه", "شرفخانه", "خداجو", "دوزدوزان", "خروسلو", "تیکمه داش", "آبش احمد", "ترک", "آچاچی", "سیه رود", "خمارلو", "خداآفرین", "لیلان"],
        "آذربایجان غربی": ["ارومیه", "خوی", "بوکان", "مهاباد", "میاندوآب", "سلماس", "پیرانشهر", "نقده", "تکاب", "ماکو", "سردشت", "شاهین‌دژ", "اشنویه", "قره‌ضیاءالدین", "شوط", "سیه‌چشمه", "ربط", "پلدشت", "بازرگان", "چهاربرج", "محمدیار", "فیرورق", "تازه شهر", "نوشین شهر", "دیزج دیز", "محمودآباد", "میرآباد", "کوتول", "باروق", "گردکشانه", "آواجیق", "سیلوانه", "حاجی لار", "کشاورز", "ایواوغلی", "نالوس", "قوشچی", "یولاگلدی", "خلیفان", "سرو", "مرگنلر"],
        "اردبیل": ["اردبیل", "پارس‌آباد", "مشگین‌شهر", "خلخال", "گرمی", "بیله‌سوار", "نمین", "جعفرآباد", "گیوی", "آبی‌بیگلو", "اصلاندوز", "نیر", "عنبران", "هشتچین", "سرعین", "بابک شهر", "آلنی", "آراللو", "لاهرود", "هیر", "رضی", "قصابه", "بنی جعفر", "اسلام آباد", "مرادلو", "فخرآباد", "کلور", "ثمرین", "کوراییم"],
        "اصفهان": ["اصفهان", "کاشان", "خمینی‌شهر", "نجف‌آباد", "شاهین‌شهر", "داران", "شهرضا", "تیران", "مبارکه", "زرین‌شهر", "آران و بیدگل", "گلپایگان", "فریدون‌شهر", "دهاقان", "چادگان", "فلاورجان", "نایین", "سمیرم", "خوانسار", "گز", "اردستان", "مهاباد", "زیباشهر", "مجلس", "کوشک", "محمدآباد", "نیک‌آباد", "ورزنه", "اژیه", "قهجاورستان", "بهارستان", "خورزوق", "دستگرد", "شاپورآباد", "گرگاب", "حبیب‌آباد", "کمیشچه", "دولت‌آباد", "ابریشم", "کلیشاد و سودرجان", "قهدریجان", "دیزیچه", "کرکوند", "طالخونچه", "مجلسی", "باغ‌بهادران", "چرمهین", "باغشاد", "زاینده‌رود", "وزوان", "میمه", "لای‌بید", "جوزدان", "اصغرآباد", "کهریزسنگ", "گلدشت", "رضوان‌شهر", "عسگران", "علویجه", "دهق", "منظریه", "قمصر", "جوشقان قالی", "کامو و چوگان", "مشکات", "برزک", "نیاسر", "بادرود", "خالدآباد", "طرق‌رود", "بویین و میاندشت", "برف‌انبار", "افوس", "رزوه", "نصرآباد", "محمدآباد", "مشهد اردهال", "کاشان"],
        "البرز": ["کرج", "هشتگرد", "نظرآباد", "محمدشهر", "کمال‌شهر", "ماهدشت", "مشکین‌دشت", "گرمدره", "گلسار", "اشتهارد", "طالقان", "کوهسار", "چهارباغ", "شهرجدیدهشتگرد", "تنکمان", "آسارا", "پلنگ‌آباد"],
        "ایلام": ["ایلام", "دهلران", "ایوان", "آبدانان", "دره‌شهر", "مهران", "سرابله", "ارکواز", "آسمان‌آباد", "چوار", "پهله", "بدره", "شباب", "دلگشا", "مورموری", "زرنه", "لومار", "موسیان", "میمه", "توحید", "بلاوه", "صالح آباد"],
        "بوشهر": ["بوشهر", "برازجان", "بندر گناوه", "بندر کنگان", "خورموج", "جم", "بندر دیلم", "بندر دیر", "عالی‌شهر", "آب‌پخش", "چغادک", "اهرم", "بنک", "نخل تقی", "وحدتیه", "بندر ریگ", "کاگی", "بندر سیراف", "سعدآباد", "شبانکاره", "جزیره خارک", "دالکی", "بندر عسلویه", "بردخون", "آباد", "بیدخون", "دلوار", "بادوله", "آبدان", "انارستان", "تنگ ارم", "ریز", "بندر عامری", "شیرینو", "چاه مبارک", "دوراهک", "بوشکان", "کلمه", "بندر امام حسن"],
        "تهران": ["تهران", "اسلام‌شهر", "گلستان", "قدس", "ملارد", "ورامین", "شهریار", "قرچک", "نسیم‌شهر", "پاکدشت", "اندیشه", "رباط‌کریم", "پرند", "باغ‌ستان", "پرخیس", "باقرشهر", "پیشوا", "صالحیه", "صباشهر", "چهاردانگه", "دماوند", "حسن‌آباد", "ری", "کهریزک", "وحیدیه", "نصیرشهر", "فردوسیه", "رودهن", "شاهدشهر", "صفادشت", "فیروزکوه", "لواسان", "شمشک", "آبسرد", "شریف‌آباد", "فشم", "جوادآباد", "کیلان", "آبعلی", "ارجمند"],
        "چهارمحال و بختیاری": ["شهرکرد", "بروجن", "لردگان", "فرخ‌شهر", "فارسان", "هفشجان", "جونقان", "سامان", "فرادرنبه", "بن", "کیان", "سورشجان", "بلداجی", "باباحیدر", "اردل", "نقنه", "پرنجان", "شلمزار", "گندمان", "گهرو", "گوجان", "طاقانک", "ناغان", "سردشت", "سودجان", "سفیددشت", "آلونی", "دستنا", "چلیچه", "وردنجان", "کاج", "نافچ", "مال‌خلیفه", "دشتک", "هارونی", "چلگرد", "سرخون", "بازفت", "منج", "صمصامی"],
        "خراسان جنوبی": ["بیرجند", "قاین", "طبس", "فردوس", "نهبندان", "بشرویه", "سرایان", "سربیشه", "اسلامیه", "حاجی‌آباد", "خوسف", "خضری دشت بیاض", "آیسک", "نیمبلوک", "طبس مسینا", "سه قلعه", "عشق‌آباد", "آرین‌شهر", "اسدیه", "مود", "شوسف", "دیهوک", "ارسک", "قهستان", "گزیک", "زهان", "ماژان"],
        "خراسان رضوی": ["مشهد", "نیشابور", "سبزوار", "تربت حیدریه", "کاشمر", "قوچان", "تربت جام", "تایباد", "چناران", "سرخس", "گناباد", "فریمان", "گلبهار", "درگز", "خواف", "بردسکن", "طرقبه", "فیض‌آباد", "نقاب", "شاندیز", "خرو", "رشتخوار", "باخرز", "بجستان", "کاریز", "مشهد ریزه", "دولت‌آباد", "جغتای", "نشتیفان", "خلیل‌آباد", "سلامی", "ششتمد", "صالح‌آباد", "فرهادگرد", "قلندرآباد", "سفیدسنگ", "کاخک", "درود", "رضویه", "احمدآباد صولت", "شهرزو", "کدکن", "جنگل", "کندر", "آنابد", "قدمگاه", "یونسی", "شادمهر", "سلطان‌آباد", "فیروزه", "در ریگ", "بیدخت", "نصرآباد", "نیل‌شهر", "روداب", "سنگان", "قاسم‌آباد", "مزداوند", "بار", "اسحاق‌آباد", "عبدل‌آباد", "چکنه‌", "همت‌آباد", "رباط سنگ", "نوخندان", "چاپشلو", "ریوش", "داورزن", "شهرآباد", "باجگیران", "ملک‌آباد", "بیکاه", "شنببه", "عشق‌آباد"],
        "خراسان شمالی": ["بجنورد", "شیروان", "اسفراین", "آشخانه", "جاجرم", "گرمه", "فاروج", "درق", "ایور", "راز", "زیارت", "سنخواست", "شوقان", "غلامان", "قاضی", "پیش‌قلعه", "حصار گرم‌خان", "لوجلی", "تیتکانلو", "صفی‌آباد", "چناران شهر", "آوا"],
        "خوزستان": ["اهواز", "دزفول", "آبادان", "ماهشهر", "اندیمشک", "خرمشهر", "بهبهان", "ایذه", "شوشتر", "مسجدسلیمان", "بندر امام خمینی", "رامهرمز", "امیدیه", "شوش", "شادگان", "سوسنگرد", "چمران", "هندیجان", "شیبان", "باغ‌ملک", "رامشیر", "گتوند", "حمیدیه", "لالی", "هویزه", "ملاثانی", "ویس", "تشان", "آغاجاری", "ترکالکی", "دارخوین", "چغامیش", "بستان", "دهدز", "الوان", "صالح شهر", "اروندکنار", "سردشت", "شاوور", "حسینیه", "میانرود", "منصوریه", "مینوشهر", "بیدروبه", "زهره", "مشراگه", "جایزان", "صیدون", "قلعه خواجه", "حر", "شمس‌آباد", "آبژدان", "چویبده", "میداود", "سماله", "گوریه", "صالح مشطت", "جنت مکان", "حمزه", "کوت سیدنعیم", "سیاه منصور", "خنافره", "قلعه‌تل", "ابوحمیظه", "چم گلک", "آزادی", "شهر امام"],
        "زنجان": ["زنجان", "ابهر", "خرمدره", "قیدار", "هیدج", "صائین‌قلعه", "سلطانیه", "سجاس", "ماه نشان", "سهرورد", "گرماب", "آب‌بر", "دندی", "زرین‌رود", "نوربهار", "کرسف", "چورزق", "حلب", "نیک پی", "ارمغانخانه", "زرین‌آباد"],
        "سمنان": ["سمنان", "شاهرود", "دامغان", "گرمسار", "مهدی‌شهر", "ایوانکی", "شهمیرزاد", "سرخه", "بسطام", "آرادان", "مجن", "کالاته خیج", "درجزین", "دیباج", "کلاته", "میامی", "رودیان", "بیارجمند", "امیریه", "کهن‌آباد", "رضوان"],
        "سیستان و بلوچستان": ["زاهدان", "زابل", "ایرانشهر", "چابهار", "سراوان", "خاش", "کنارک", "جالق", "نیک‌شهر", "پیشین", "سوران", "زهک", "فنوج", "گلمورتی", "اسپکه", "بمپور", "سرباز", "سیرکان", "میرجاوه", "راسک", "نگور", "محمدان", "قصرقند", "نصرت‌آباد", "بنت", "ادیمی", "هیدوچ", "دوست‌محمد", "محمدآباد", "نوک‌آباد", "بزمان", "زرآباد", "آشار", "گشت", "علی اکبر", "محمدی", "کتیج", "پارود", "ریگ ملک", "هیرمند", "قرقی", "لادیز", "سفیدآبه", "چگردک", "ده رئیس"],
        "فارس": ["شیراز", "مرودشت", "جهرم", "فسا", "کازرون", "صدرا", "داراب", "فیروزآباد", "لار", "آباده", "نورآباد", "نی‌ریز", "اقلید", "استهبان", "گراش", "زرقان", "کوار", "لامرد", "صفاشهر", "قائمیه", "حاجی‌آباد", "فراشبند", "قیر", "اوز", "خنج", "خرامه", "سروستان", "ارزنجان", "بیضا", "سوریان", "مهر", "آباده طشک", "سیدان", "کوپن", "زاهدشهر", "گله‌دار", "خشت", "بوانات", "اشکنان", "بانش", "مشکان", "بنارویه", "مصیری", "شهرپیر", "دبیران", "لطیفی", "بی‌رَم", "جویم", "دژکرد", "عمادشهر", "ایزدخواست", "خاوران", "نودان", "کامفیروز", "خومه‌زار", "علامرودشت", "بهمن", "قطب‌آباد", "خانیمن", "کره‌ای", "ششده", "میان‌شهر", "ایگدر", "کارزین", "نوبندگان", "چاه‌ورز", "فدامی", "رستاق", "سورمق", "حسامی", "مزایجان", "دهرم", "کوه‌نجان", "خیرآباد", "دوزه", "جنت‌شهر", "باب‌انار", "کمشک", "نوجین"],
        "قزوین": ["قزوین", "الوند", "محمدیه", "تاکستان", "آبیک", "بوئین‌زهرا", "محمودآباد نمونه", "بیدستان", "شریفیه", "اقبالیه", "خاکعلی", "آبگرم", "دانسفهان", "ضیاءآباد", "خرمدشت", "نرجه", "سگزآباد", "شال", "ارداق", "آوج", "معلم‌کلایه", "کوهین", "رازمیان", "سیردان"],
        "قم": ["قم", "جعفریه", "پرذیسان", "قنوات", "کهک", "دستجرد", "سلفچگان"],
        "کردستان": ["سنندج", "سقز", "مریوان", "بانی", "قروه", "کامیاران", "بیجار", "دیواندره", "دهگلان", "کانی‌دینار", "سریش‌آباد", "دلبران", "سروآباد", "یاسوکند", "موزه دره", "بلبان‌آباد", "نودشه", "آرمرده", "زرینه", "اورامان تخت", "صاحب", "پوکان", "شویشه", "کانی‌سور", "برده‌رشه", "بویین سفلی", "توپ‌آغاج", "پیرتاج", "چناره", "بابارشانی"],
        "کرمان": ["کرمان", "سیرجان", "رفسنجان", "جیرفت", "بم", "زرند", "کهنوج", "شهربابک", "بافت", "بردسیر", "راور", "بروات", "محمدآباد", "نجف‌شهر", "ماهان", "عنبرآباد", "منوجان", "انار", "رودبار", "رابر", "قلعه‌گنج", "کوهبنان", "درب بهشت", "باغین", "رای‌ن", "نگار", "مس سرچشمه", "چترود", "یزدان‌شهر", "خورسند", "پاریز", "کشکوئیه", "خانوک", "ریحان‌شهر", "کیان‌شهر", "بزنجان", "لاله‌زار", "امین‌شهر", "دهج", "ارزوییه", "گلزار", "فاریاب", "فهرج", "جوپار", "رمشک", "بلوک", "جبالبارز", "علی‌آباد", "نودژ", "هنزا", "کاظم‌آباد", "زنگی‌آباد", "محی‌آباد", "اختیارآباد", "دوساری", "گلباف", "هجدک", "زیدآباد", "نرماشیر", "ده‌زیار", "خاتون‌آباد"],
        "کرمانشاه": ["کرمانشاه", "اسلام‌آباد غرب", "جوانرود", "کنگاور", "سرپل‌ذهاب", "سنقر", "هرسین", "صحنه", "پاوه", "روانسر", "گیلانغرب", "قصرشیرین", "تازه آباد", "کرندغرب", "بیستون", "گهواره", "کوزران", "ریجاب", "نودشه", "شابس", "هلشی", "سرمست", "بانه‌وره", "گودین", "نوسود", "باینگان", "ازگله", "میان‌راهان", "سطر", "قلعه"],
        "کهگیلویه و بویراحمد": ["یاسوج", "دوگنبدان", "دهدشت", "لیکک", "چرام", "لنده", "باشت", "سی‌سخت", "سوق", "دیشموک", "قلعه رئیسی", "مارگون", "پاتاوه", "سرفاریاب", "چیتاب", "گراب سفلی"],
        "گلستان": ["گرگان", "گنبدکاووس", "بندر ترکمن", "علی‌آباد کتول", "آزادشهر", "کردکوی", "کلاله", "آق‌قلا", "مینودشت", "گالیکش", "بندر گز", "فاضل‌آباد", "گمیش‌تپه", "سیمین‌شهر", "رامیان", "خان‌ببین", "مراوه‌تپه", "دلند", "نگین‌شهر", "جلین", "سرخنکلاته", "انبارآلوم", "نوکنده", "فراغی", "تاتار علیا", "سنگدوین", "مزرعه", "نوده خاندوز", "اینچه‌برون"],
        "گیلان": ["رشت", "بندر انزلی", "لاهیجان", "لنگرود", "هشتپر", "آستارا", "صومعه‌سرا", "آستانه اشرفیه", "رودسر", "فومن", "خمام", "سیاهکل", "رضوانشهر", "ماس", "منجیل", "املش", "کی‌اشهر", "رستم‌آباد", "لوشان", "سنگر", "کلاچای", "آستانه", "رودبار", "کوچصفهان", "شفت", "شاندرمن", "چاف و چمخاله", "چوبر", "لشت نشا", "پره‌سر", "خشکبیجار", "مرجقل", "کومله", "بازارجمعه", "گوراب زرمیخ", "واجارگاه", "حویق", "لیسار", "رودبنه", "جیرنده", "رانکوه", "احمدسرگوراب", "اتاقور", "دیلمان", "بره‌سر", "ماسوله", "توتکابن", "ماکلوان"],
        "لرستان": ["خرم‌آباد", "بروجرد", "دورود", "الیگودرز", "کوهدشت", "نورآباد", "ازنا", "الشتر", "پلدختر", "کونانی", "معمولان", "چقابل", "اشترینان", "فیروزآباد", "گراب", "سپیددشت", "زاغه", "چمن‌سلطان", "درب‌گنبد", "ویسیان", "شول‌آباد", "مومن‌آباد", "سراب‌دوره", "هفت‌چشمه"],
        "مازندران": ["ساری", "بابل", "آمل", "قائم‌شهر", "بهشهر", "چالوس", "نکا", "بابلسر", "تنکابن", "نوشهر", "فریدون‌کنار", "رامسر", "جویبار", "محمودآباد", "امیرکلا", "نور", "گلوگاه", "کتالم و سادات‌شهر", "زیرآب", "عباس‌آباد", "خلیل‌شهر", "رستمکلا", "خرم‌آباد", "شیرود", "چمستان", "کلاردشت", "هچیرود", "سلمان‌شهر", "ارطه", "پل‌سفید", "کی‌اکلا", "بهنمیر", "هادی‌شهر", "رویان", "ایزدشهر", "گتاب", "گلوگاه", "سرخرود", "مرزن‌آباد", "نشتارود", "کلارآباد", "آلاشت", "امام‌زاده عبدالله", "خوش‌رودپی", "زرگرمحله", "پول", "کجور", "فریم", "شیرگاه", "مرزیکلا", "دابودشت", "رینه", "پایین هولار", "بلده", "گزنک", "سوادکوه"],
        "مرکزی": ["اراک", "ساوه", "خمین", "محلات", "دلیجان", "مامونیه", "شازند", "مهاجران", "تفرش", "میلاجرد", "آشتیان", "خنداب", "آستانه", "پرندک", "زاویه", "نیم‌ور", "فرم‌هین", "ساروق", "خشکرود", "خنجین", "نراق", "توره", "غرق‌آباد", "جاورسیان", "هندودر", "قورچی‌باشی", "نوبران", "کارچان", "رازقان"],
        "هرمزگان": ["بندرعباس", "میناب", "قشم", "کیش", "رودان", "بندر لنگه", "پارسیان", "جاسک", "حاجی‌آباد", "بندر خمیر", "درگهان", "بستک", "بندر چارک", "خمیر", "رویدر", "جناح", "تازیان پایین", "تیرور", "لمزان", "سیریک", "سوزا", "قلعه قاضی", "هرمز", "فین", "بیکاه", "زیارت‌علی", "سندرک", "کوشکنار", "تخت", "فارغان", "سرگز", "ابوموسی", "گروک", "دهبارز"],
        "همدان": ["همدان", "ملایر", "نهاوند", "تویسرکان", "اسدآباد", "کبودرآهنگ", "بهار", "رزن", "لالجین", "فامنین", "مریانج", "ازندریان", "قروه درجزین", "جورقان", "گیان", "صالح‌آباد", "مهاجران", "فیروزان", "سرکان", "سامن", "دمق", "اسلام‌شهر آق‌گل", "آجین", "شیرین‌سو", "برزول", "قهاوند", "جوکار", "گل‌تپه", "فرسفج", "زنگنه"],
        "یزد": ["یزد", "میبد", "اردکان", "بافق", "مهریز", "ابرکوه", "اشکذر", "تفت", "شاهدیه", "حمیدیا", "زارچ", "بهاباد", "مهردشت", "بفروئیه", "احمدآباد", "مروست", "خضرآباد", "عقدا", "نیر", "بخ", "هرات"]
    };

    document.addEventListener('DOMContentLoaded', function() {
        // متغیرها
        const stateSelect = document.getElementById('inp-state');
        const citySelect = document.getElementById('inp-city');
        const editBtns = document.querySelectorAll('.edit-address-btn');
        const btnCancel = document.getElementById('btn-cancel-edit');
        const formContainer = document.getElementById('address-form-container');
        
        // فرم و فیلدها
        const mainForm = document.getElementById('main-address-form');
        const formAction = document.getElementById('form-action');
        const formId = document.getElementById('form-address-id');
        const formTitle = document.getElementById('form-title');
        const btnSubmit = document.getElementById('btn-submit');
        const inpName = document.getElementById('inp-fullname');
        const inpPhone = document.getElementById('inp-phone');
        const inpAddress = document.getElementById('inp-address');
        const inpZip = document.getElementById('inp-zip');

        // 1. پر کردن لیست استان‌ها در شروع کار
        for (let province in iranCities) {
            let option = document.createElement('option');
            option.value = province;
            option.text = province;
            stateSelect.appendChild(option);
        }

        // 2. تابع بروزرسانی شهرها بر اساس استان
        function updateCities(selectedProvince, selectedCity = null) {
            // پاک کردن شهرهای قبلی
            citySelect.innerHTML = '<option value="">انتخاب شهر *</option>';
            
            if (selectedProvince && iranCities[selectedProvince]) {
                iranCities[selectedProvince].forEach(city => {
                    let option = document.createElement('option');
                    option.value = city;
                    option.text = city;
                    // اگر شهری برای انتخاب مد نظر است (حالت ویرایش)
                    if (selectedCity && city === selectedCity) {
                        option.selected = true;
                    }
                    citySelect.appendChild(option);
                });
            } else {
                citySelect.innerHTML = '<option value="">ابتدا استان را انتخاب کنید *</option>';
            }
        }

        // 3. رویداد تغییر استان
        stateSelect.addEventListener('change', function() {
            updateCities(this.value);
        });

        // 4. مدیریت دکمه ویرایش
        editBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const data = JSON.parse(this.getAttribute('data-address'));
                
                // پر کردن فیلدهای متنی
                inpName.value = data.full_name;
                inpPhone.value = data.phone;
                inpAddress.value = data.address;
                inpZip.value = data.zip_code;
                formId.value = data.id;

                // تنظیم استان
                stateSelect.value = data.state;
                
                // بروزرسانی لیست شهرها و انتخاب شهر درست
                updateCities(data.state, data.city);

                // تغییر وضعیت فرم
                formAction.value = 'update_address';
                formTitle.innerText = 'ویرایش آدرس';
                btnSubmit.innerText = 'بروزرسانی آدرس';

                // اسکرول به فرم
                formContainer.scrollIntoView({behavior: 'smooth'});
            });
        });

        // 5. مدیریت دکمه انصراف
        btnCancel.addEventListener('click', function() {
            mainForm.reset();
            
            // ریست کردن لیست شهرها
            citySelect.innerHTML = '<option value="">ابتدا استان را انتخاب کنید *</option>';
            
            formAction.value = 'add_address';
            formId.value = '';
            formTitle.innerText = 'افزودن آدرس جدید';
            btnSubmit.innerText = 'ثبت آدرس';
        });
    });
</script>
